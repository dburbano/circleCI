version: 2
jobs:
  checkout-test:
    docker: #Docker executor type
      - image: circleci/node:4.8.2 #Container where you are going to execute the commands.
    steps:
      - checkout #Checkout the code in the project directory
      - run:
          name: "Get directory name and get info"
          command: pwd && ls -all
      - persist_to_workspace:
          root: ./
          paths:
            - .circleci
  aws-test:
    docker: #Doker image to use aws resources
      - image: circleci/python:2.7-jessie
    environment:
      BUCKET_REPO: "mach-mobile-automation-repos"
      TEST_REPO: "test"
      PROJECT_NAME: "pipeline-ios-project"
      PROJECT_ARN: "arn:aws:devicefarm:us-west-2:425782179927:project:69683c23-ccfb-4308-b0f8-33f34d6098e0"
      DEVICE_POOL_NAME: "ApplePhone"
      DEVICE_POOL_ARN: "arn:aws:devicefarm:us-west-2:425782179927:devicepool:69683c23-ccfb-4308-b0f8-33f34d6098e0/67db20ae-9259-439a-ad35-bf29773e5ce4"
      RUN_NAME: "Smoke-CircleCI-Test"
      IPA_PATH: "./machApp/build/dev"
      IPA_FILE: "machApp-dev-ops.ipa"
      IPA_OUTPUT_LOG: "machApp-dev.log"
      TEST_OUTPUT_LOG: "test-output.log"
      AVAILABLE_TESTS: "available-ios-tests"
      TEST_ARN_LIST_FILE: "smoke-test-arn-list"
      PLATFORM: "ios"
      ENV: "-ops"
    steps:
      - attach_workspace:
          at: ./
      - run:
          name: Install awscli
          command: sudo pip install awscli
      - run:
          name: Get IPA file from S3
          command: |
            aws s3 cp s3://${BUCKET_REPO}/${PLATFORM}/${IPA_FILE} ./${IPA_FILE}
            pwd && ls -all
      - run:
          name: Send Smoke test to AWS Device Farm
          command: chmod 755 ./.circleci/circleci-smoke-test.sh && ./.circleci/circleci-smoke-test.sh

workflows:
  version: 2
  test-in-devicefarm:
    jobs:
      - checkout-test:
          filters:
            branches:
              only: aws-communication
      - aws-test:
          requires:
            - checkout-test
